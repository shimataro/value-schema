# https://docs.github.com/en/actions/creating-actions/creating-a-composite-action
name: Build
description: Composite action (Build)

inputs:
  os:
    description: host OS that CI 'runs-on'
    required: true
  nodejs:
    description: Node.js version for build
    required: false
    default: "16"
  registry-url:
    description: Optional registry to set up for auth. Will set the registry in a project level .npmrc and .yarnrc file, and set up auth to read in from env.NODE_AUTH_TOKEN.
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Install Node.js for build
      uses: ./.github/actions/nodejs
      with:
        nodejs: ${{ inputs.nodejs }}

    # Install dependencies (using cache)
    # https://github.com/actions/cache/blob/master/examples.md#node---npm
    # https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#environment-files
    - name: Get npm cache directory
      run: echo "npm_cache=$(npm config get cache)" >> ${{ github.env }}
      shell: pwsh # use PowerShell; the format of "github.env" on Windows is like "D:\a\_temp\_runner_file_commands\set_env_XXX", and bash can't write to it.
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: ${{ env.npm_cache }}
        key: npm-${{ inputs.os }}-${{ inputs.nodejs }}-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          npm-${{ inputs.os }}-${{ inputs.nodejs }}-
          npm-${{ inputs.os }}-
    - name: Install dependencies
      run: npm ci
      shell: bash

    # Build
    - name: Build
      run: npm run build
      shell: bash
